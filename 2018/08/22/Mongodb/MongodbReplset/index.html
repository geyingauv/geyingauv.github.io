<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="virle's blog, virle, geying, geyingauv"><title>Mongodb 复制集部署 + 权限认证 - Virle's blog</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/geyingauv"><span>Github</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="/post-bg.jpg"><div class="post-title"><h1 class="title">Mongodb 复制集部署 + 权限认证</h1><ul class="meta"><li><i class="icon icon-author"></i>Virle</li><li><i class="icon icon-clock"></i>18 Minutes</li><li><i class="icon icon-calendar"></i>August 22, 2018</li></ul></div></div><div class="article-content" style="max-width:800px"><h1 id="Mongodb-复制集部署-权限认证"><a href="#Mongodb-复制集部署-权限认证" class="headerlink" title="Mongodb 复制集部署 + 权限认证"></a>Mongodb 复制集部署 + 权限认证</h1><h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><p>机器：</p>
<ul>
<li>host 1:27017 Primary</li>
<li>host 1:27018 Arbiter<ul>
<li>host 2:27017 Secondary</li>
</ul>
</li>
</ul>
<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>两台机器分别部署两个节点，Primary 提供服务，Secondary 提供备份，当 Primary 宕机时，Secondary 可以代替 Primary 继续提供服务</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li><p>在 host 1 启动 Primary</p>
</li>
<li><p>在 host 2 启动 Secondary</p>
</li>
<li><p>在 host 1 启动 Arbiter</p>
</li>
<li><p>初始化 Replset</p>
</li>
<li><p>查看状态</p>
</li>
<li><p>测试</p>
</li>
</ol>
<hr>
<p><strong>本文中 {depPath} 指 mongodb 存放的路径 ，配置文件中为了方便查看，实际使用时请自行补全</strong></p>
<p>创建 keyfile ，使用 keyfile 校验才能加入复制集</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwd </span><br><span class="line"><span class="meta">#</span>  &#123;depPath&#125;/mongodb</span><br><span class="line">openssl rand -base64 756 &gt; keyfile</span><br><span class="line">chmod 600 keyfile  # 官方文档写的400</span><br></pre></td></tr></table></figure>
<p>复制keyfile到各实例目录下，注意用户和用户组，保证启动 mongodb 实例的用户有访问权限 keyfile 权限过大无法启动实例</p>
<p>host1：{depPath}/mongodb/mongodb.cnf</p>
<p>host2：{depPath}/mongodb/mongodb.cnf</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">port</span>=<span class="number">27017</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dbpath</span>=/mongodb/data/</span><br><span class="line"></span><br><span class="line"><span class="attr">logpath</span>=/mongodb/mongodb.log</span><br><span class="line"></span><br><span class="line"><span class="attr">pidfilepath</span>=/mongodb/mongo.pid</span><br><span class="line"></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bind_ip</span>=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#auth=true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">storageEngine</span>=wiredTiger</span><br><span class="line"></span><br><span class="line"><span class="attr">wiredTigerCacheSizeGB</span>=<span class="number">1</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#keyFile=/mongodb/keyfile</span></span><br><span class="line"></span><br><span class="line"><span class="attr">replSet</span>=reptest</span><br></pre></td></tr></table></figure>
<p>host1：{depPath}/mongodb_arb/mongodb.cnf</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">port</span>=<span class="number">27017</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dbpath</span>=/mongodb_arb/data/arb</span><br><span class="line"></span><br><span class="line"><span class="attr">logpath</span>=/mongodb_arb/mongodb.log</span><br><span class="line"></span><br><span class="line"><span class="attr">pidfilepath</span>=/mongodb_arb/mongo.pid</span><br><span class="line"></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bind_ip</span>=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">auth</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">storageEngine</span>=wiredTiger</span><br><span class="line"></span><br><span class="line"><span class="attr">wiredTigerCacheSizeGB</span>=<span class="number">1</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">keyFile</span>=/mongodb_arb/keyfile</span><br><span class="line"></span><br><span class="line"><span class="attr">replSet</span>=reptest</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> host 1: 启动 Primary , </span><br><span class="line">/mongodb/bin/mongodb -f /mongodb/mongodb.cnf</span><br><span class="line"><span class="meta">#</span> 进入 mongo shell</span><br><span class="line">/mongodb/bin/mongo</span><br><span class="line"><span class="meta">#</span> 首次进入创建用户</span><br><span class="line">use admin</span><br><span class="line"><span class="meta">#</span> 创建 admin 管理员</span><br><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: "root",</span><br><span class="line">    pwd: "root",</span><br><span class="line">    roles: [ &#123; role: "userAdminAnyDatabase", db: "admin" &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"><span class="meta">#</span> 创建clusterAdmin</span><br><span class="line">db.createUser(</span><br><span class="line">	&#123;</span><br><span class="line">		user: "dba",</span><br><span class="line">		pwd: "dba",</span><br><span class="line">		roles: [ &#123; role: "clusterAdmin", db: "admin" &#125; ]</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>首次通过本地的 <code>shell</code>进入，是可以直接创建用户的，之后创建用户需要认证 <code>admin</code> 角色。</p>
<p>创建完用户把配置文件中的 <code>keyfile</code> 和 <code>auth</code> 注释取消掉，重启 host 1 Primary 实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> host 2: 启动 Secondary </span><br><span class="line">/mongodb/bin/mongodb -f /mongodb/mongodb.cnf</span><br><span class="line"><span class="meta">#</span> host 1: 启动 Arbiter</span><br><span class="line">/mongodb_arb/bin/mongodb /mongodb_arb/mongodb.cnf</span><br></pre></td></tr></table></figure>
<p>在 host 1 进入 mongo shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>## host 和 ip 请自行替换</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 进入 shell</span><br><span class="line">/mongodb/bin/mongo</span><br><span class="line">use admin </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 认证（clusterAdmin）</span><br><span class="line">db.auth('dba','dba')</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 初始化复制集</span><br><span class="line">rs.initiate(</span><br><span class="line">   &#123;</span><br><span class="line">      _id: "reptest",</span><br><span class="line">      version: 1,</span><br><span class="line">      members: [</span><br><span class="line">         &#123; _id: 0, host : "host 1:27017" &#125;,</span><br><span class="line">         &#123; _id: 1, host : "host 2:27017" &#125;,</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 添加一个 Arb 节点</span><br><span class="line">rs.addArb("host 1:27018")</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看状态</span><br><span class="line">rs.status()</span><br></pre></td></tr></table></figure>
<p>rs 命令只能在 Primary 节点修改设置，是否为 Primary 显示在命令行头部</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reptest:PRIMARY&gt;</span><br><span class="line">reptest:SECONDARY&gt;</span><br></pre></td></tr></table></figure>
<h2 id="spring-data-mongodb-复制集配置"><a href="#spring-data-mongodb-复制集配置" class="headerlink" title="spring-data-mongodb 复制集配置"></a>spring-data-mongodb 复制集配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 如果需要验证 使用 credentials 属性 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mongo:mongo-client</span> <span class="attr">id</span>=<span class="string">"mongo"</span> <span class="attr">replica-set</span>=<span class="string">"host 1:27017，host 2:27017"</span> <span class="attr">credentials</span>=<span class="string">"databaseName:username@password"</span>&gt;</span></span><br><span class="line">		 <span class="tag">&lt;<span class="name">mongo:client-options</span> <span class="attr">write-concern</span>=<span class="string">"SAFE"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">connections-per-host</span>=<span class="string">"8"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">threads-allowed-to-block-for-connection-multiplier</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">connect-timeout</span>=<span class="string">"1000"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">max-wait-time</span>=<span class="string">"1500"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">socket-keep-alive</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">socket-timeout</span>=<span class="string">"1500"</span></span></span><br><span class="line"><span class="tag">           /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">mongo:mongo-client</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">mongo:db-factory</span> <span class="attr">dbname</span>=<span class="string">"databaseName"</span> <span class="attr">mongo-ref</span>=<span class="string">"mongo"</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mongoTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.mongodb.core.MongoTemplate"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"mongoDbFactory"</span> <span class="attr">ref</span>=<span class="string">"mongoDbFactory"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://docs.mongodb.com/v3.6/tutorial/create-users/#add-users" target="_blank" rel="noopener">Add Users</a></p>
<p><a href="https://docs.mongodb.com/v3.6/tutorial/enable-authentication/#enable-auth" target="_blank" rel="noopener">Enable Auth</a></p>
<p><a href="https://docs.mongodb.com/v3.6/tutorial/deploy-replica-set-with-keyfile-access-control/index.html#deploy-new-replica-set-with-keyfile-access-control" target="_blank" rel="noopener">Deploy New Replica Set With Keyfile Access Control</a></p>
<p><a href="https://docs.mongodb.com/v3.6/tutorial/enforce-keyfile-access-control-in-existing-replica-set/#enforce-keyfile-access-control-in-a-replica-set" target="_blank" rel="noopener">Enforce Keyfile Access Control in a Replica Set</a></p>
<p><a href="https://docs.mongodb.com/v3.6/replication/#replication" target="_blank" rel="noopener">Replication</a></p>
<p><a href="https://docs.mongodb.com/v3.6/core/replica-set-arbiter/#replica-set-arbiter" target="_blank" rel="noopener">Replica Set Arbiter</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>部署时遇到的问题挺多，比如认证是以前就有的，在配置文件中使用了 <code>ReplSet</code> 和 <code>keyfile</code> 后 mongo shell 中执行的命令很多都提示没有认证 <code>admin</code> 权限，后来发现使用 <code>ReplSet</code> 执行命令需要 <code>clusterAdmin</code>。</p>
<p>本来目的时两个节点可以互相切换。实际操作时一个节点挂掉，另一个并不会自动切换为 PRIMARY ，后来通过文档发现有 <a href="https://docs.mongodb.com/v3.6/core/replica-set-arbiter/#replica-set-arbiter" target="_blank" rel="noopener">Replica Set Arbiter</a> 的概念，因为只有一个节点时无法完成投票选举，需要添加一个 Arbiter 节点来投票。</p>
<p>多看文档少百度，文章是部署后所写，只提供思路和流程，具体操作请按实际环境进行相应的修改，如有错误之处，还望指出。</p>
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mongodb/">Mongodb</a><span class="tag-list-count">1</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2018/08/30/book/2018-09/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2018/08/06/Swift/URLSession/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/geyingauv" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/geyingauv" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2018 Virle's blog</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>