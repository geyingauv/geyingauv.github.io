<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="virle's blog, virle, geying, geyingauv"><title>Spring boot 过滤器配置及源码调试 - Virle's blog</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c3d02a6e0e241c65a29e535825d0d1db";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/geyingauv"><span>Github</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="/post-bg.jpg"><div class="post-title"><h1 class="title">Spring boot 过滤器配置及源码调试</h1><ul class="meta"><li><i class="icon icon-author"></i>Virle</li><li><i class="icon icon-clock"></i>35 Minutes</li><li><i class="icon icon-calendar"></i>December 27, 2018</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h2><ol>
<li>创建自定义拦截器类 <code>MyFilterA</code> 实现 <code>Filter</code> 接口</li>
<li>重写 <code>doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</code> 方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilterA</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Java-代码配置过滤器"><a href="#Java-代码配置过滤器" class="headerlink" title="Java 代码配置过滤器"></a>Java 代码配置过滤器</h2><ol start="3">
<li>创建配置类 <code>FilterConfiguration</code></li>
<li>使用注解 <code>@Configuration</code></li>
<li>定义一个 bean</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">customFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">    registration.setFilter(<span class="keyword">new</span> MyFilterA());</span><br><span class="line">    registration.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">    registration.setName(<span class="string">"customFilter1"</span>);</span><br><span class="line">    registration.setOrder(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> registration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注解配置"><a href="#注解配置" class="headerlink" title="注解配置"></a>注解配置</h2><ul>
<li>最直接的方法就是在自定义过滤器类加上 <code>@Component</code> 注解，但是这种方式会过滤所有请求，而且没法配置</li>
<li>在自定义类添加 <code>@WebFilter(urlPatterns = &quot;/*&quot;, filterName = &quot;customFilter1&quot;)</code> 注解，并且在启动类上添加 <code>@ServletComponentScan</code> 注解</li>
</ul>
<h2 id="多个-Filter-过滤顺序"><a href="#多个-Filter-过滤顺序" class="headerlink" title="多个 Filter 过滤顺序"></a>多个 Filter 过滤顺序</h2><ul>
<li><p>代码配置<br>定义多个 CustomFilter ，在配置类中定义多个 Bean ，设置 <code>registration.setOrder(1);</code> 进行过滤器排序</p>
</li>
<li><p>注解配置<br>网上看到好多帖子里说要在过滤器上添加 <code>@Order()</code> 注解，经过测试这是无效的<br><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/annotation/Order.html" target="_blank" rel="noopener">JavaDoc:org.springframework.core.annotation.Order</a> 的描述是</p>
<blockquote>
<p>Since Spring 4.0, annotation-based ordering is supported for many kinds of components in Spring</p>
</blockquote>
<p>  支持部分组件的排序，而且不会影响单例的启动顺序，Filter 也是单例的吧。</p>
</li>
</ul>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>以上就是 Spring Boot 关于过滤器的配置</p>
<h2 id="折腾"><a href="#折腾" class="headerlink" title="折腾"></a>折腾</h2><p>不折腾不舒服星人表示不知道原因就很不爽。<br>找到第请求时初始化过 <code>FilterChain</code> 的位置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the filter chain for this request</span></span><br><span class="line">ApplicationFilterChain filterChain =</span><br><span class="line">        ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br></pre></td></tr></table></figure></p>
<p>创建 <code>createFilterChain</code> 方法</p>
<p>可以看到 <code>new ApplicationFilterChain();</code> 只是创建了一个空的 <code>ApplicationFilterChain</code> 对象</p>
<p>继续步进，发现 <code>FilterMap filterMaps[] = context.findFilterMaps();</code> 从 context 获取了 FilterMap 的数组</p>
<p>再往下开始遍历数组，匹配 url 规则，然后获取 <code>filterName</code> 通过 <code>filterName</code> 获取 <code>FilterConfig</code> 并调用 <code>filterChain.addFilter(filterConfig);</code> 添加到 <code>FilterChain</code> 本质上是内置一个名为 <code>filters</code> 的数组。</p>
<p>经过以上外部的步骤可以大概知道过滤器大概的工作流程了，但我这次是要找过滤器是如何排序的，所以现在看看 <code>context.findFilterMaps();</code> 如何获取 <code>filterMaps[]</code> 的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Construct a FilterChain implementation that will wrap the execution of</span></span><br><span class="line"><span class="comment">     * the specified servlet instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request The servlet request we are processing</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> wrapper The wrapper managing the servlet instance</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> servlet The servlet instance to be wrapped</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The configured FilterChain instance or null if none is to be</span></span><br><span class="line"><span class="comment">     *         executed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span><span class="params">(ServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">        Wrapper wrapper, Servlet servlet)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there is no servlet to execute, return null</span></span><br><span class="line">    <span class="keyword">if</span> (servlet == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create and initialize a filter chain object</span></span><br><span class="line">    ApplicationFilterChain filterChain = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">        Request req = (Request) request;</span><br><span class="line">        <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">            <span class="comment">// Security: Do not recycle</span></span><br><span class="line">            filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filterChain = (ApplicationFilterChain) req.getFilterChain();</span><br><span class="line">            <span class="keyword">if</span> (filterChain == <span class="keyword">null</span>) &#123;</span><br><span class="line">                filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">                req.setFilterChain(filterChain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Request dispatcher in use</span></span><br><span class="line">        filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    filterChain.setServlet(servlet);</span><br><span class="line">    filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acquire the filter mappings for this Context</span></span><br><span class="line">    StandardContext context = (StandardContext) wrapper.getParent();</span><br><span class="line">    FilterMap filterMaps[] = context.findFilterMaps();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are no filter mappings, we are done</span></span><br><span class="line">    <span class="keyword">if</span> ((filterMaps == <span class="keyword">null</span>) || (filterMaps.length == <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> filterChain;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acquire the information we will need to match filter mappings</span></span><br><span class="line">    DispatcherType dispatcher =</span><br><span class="line">            (DispatcherType) request.getAttribute(Globals.DISPATCHER_TYPE_ATTR);</span><br><span class="line"></span><br><span class="line">    String requestPath = <span class="keyword">null</span>;</span><br><span class="line">    Object attribute = request.getAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR);</span><br><span class="line">    <span class="keyword">if</span> (attribute != <span class="keyword">null</span>)&#123;</span><br><span class="line">        requestPath = attribute.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String servletName = wrapper.getName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the relevant path-mapped filters to this filter chain</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!matchFiltersURL(filterMaps[i], requestPath))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">            context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line">        <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// FIXME - log configuration problem</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.addFilter(filterConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add filters that match on servlet name second</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!matchFiltersServlet(filterMaps[i], servletName))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">            context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line">        <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// FIXME - log configuration problem</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.addFilter(filterConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the completed filter chain</span></span><br><span class="line">    <span class="keyword">return</span> filterChain;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the set of filter mappings for this Context.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> FilterMap[] findFilterMaps() &#123;</span><br><span class="line">    <span class="keyword">return</span> filterMaps.asArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>是从 <code>org.apache.catalina.core.StandardContext</code> 类中获取的 filterMaps 注释的描述顺序是按部署描述定义的顺序映射的，这个内部也是个数组。另外<br>filterMaps 类型是 ContextFilterMaps ，这是 StandardContext 类的一个内部静态类，除了构造方法外只有四个方法，分别是 add addBefore asArray remove，<br>这里主要 add 和 addBefore ，实际上是被 StandardContext 的 addFilterMap 和 addFilterMapBefore ， 通过 findUsage 可以发现实际是被 addMappingForUrlPatterns 调用了。然后找 addMappingForUrlPatterns 被调用的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The set of filter mappings for this application, in the order</span></span><br><span class="line"><span class="comment">    * they were defined in the deployment descriptor with additional mappings</span></span><br><span class="line"><span class="comment">    * added via the &#123;<span class="doctag">@link</span> ServletContext&#125; possibly both before and after those</span></span><br><span class="line"><span class="comment">    * defined in the deployment descriptor.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ContextFilterMaps filterMaps = <span class="keyword">new</span> ContextFilterMaps();</span><br></pre></td></tr></table></figure>
<p>以下代码可以倒序就是启动容器的流程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMappingForUrlPatterns</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        EnumSet&lt;DispatcherType&gt; dispatcherTypes, <span class="keyword">boolean</span> isMatchAfter,</span></span></span><br><span class="line"><span class="function"><span class="params">        String... urlPatterns)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line"></span><br><span class="line">    filterMap.setFilterName(filterDef.getFilterName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dispatcherTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (DispatcherType dispatcherType : dispatcherTypes) &#123;</span><br><span class="line">            filterMap.setDispatcher(dispatcherType.name());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (urlPatterns != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// % decoded (if necessary) using UTF-8</span></span><br><span class="line">        <span class="keyword">for</span> (String urlPattern : urlPatterns) &#123;</span><br><span class="line">            filterMap.addURLPattern(urlPattern);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isMatchAfter) &#123;</span><br><span class="line">            context.addFilterMap(filterMap);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            context.addFilterMapBefore(filterMap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else error?</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configure registration settings. Subclasses can override this method to perform</span></span><br><span class="line"><span class="comment">	 * additional configuration if required.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registration the registration</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(FilterRegistration.Dynamic registration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.configure(registration);</span><br><span class="line">    EnumSet&lt;DispatcherType&gt; dispatcherTypes = <span class="keyword">this</span>.dispatcherTypes;</span><br><span class="line">    <span class="keyword">if</span> (dispatcherTypes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        dispatcherTypes = EnumSet.of(DispatcherType.REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">    Set&lt;String&gt; servletNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (ServletRegistrationBean&lt;?&gt; servletRegistrationBean : <span class="keyword">this</span>.servletRegistrationBeans) &#123;</span><br><span class="line">        servletNames.add(servletRegistrationBean.getServletName());</span><br><span class="line">    &#125;</span><br><span class="line">    servletNames.addAll(<span class="keyword">this</span>.servletNames);</span><br><span class="line">    <span class="keyword">if</span> (servletNames.isEmpty() &amp;&amp; <span class="keyword">this</span>.urlPatterns.isEmpty()) &#123;</span><br><span class="line">        registration.addMappingForUrlPatterns(dispatcherTypes, <span class="keyword">this</span>.matchAfter,</span><br><span class="line">                DEFAULT_URL_MAPPINGS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!servletNames.isEmpty()) &#123;</span><br><span class="line">            registration.addMappingForServletNames(dispatcherTypes, <span class="keyword">this</span>.matchAfter,</span><br><span class="line">                    StringUtils.toStringArray(servletNames));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.urlPatterns.isEmpty()) &#123;</span><br><span class="line">            registration.addMappingForUrlPatterns(dispatcherTypes, <span class="keyword">this</span>.matchAfter,</span><br><span class="line">                    StringUtils.toStringArray(<span class="keyword">this</span>.urlPatterns));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String description, ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">    D registration = addRegistration(description, servletContext);</span><br><span class="line">    <span class="keyword">if</span> (registration == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.info(StringUtils.capitalize(description) + <span class="string">" was not registered "</span></span><br><span class="line">                + <span class="string">"(possibly already registered?)"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    configure(registration); <span class="comment">//调用configure</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    String description = getDescription();</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">        logger.info(StringUtils.capitalize(description)</span><br><span class="line">                + <span class="string">" was not registered (disabled)"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    register(description, servletContext); <span class="comment">//调用register</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">selfInitialize</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    prepareWebApplicationContext(servletContext);</span><br><span class="line">    registerApplicationScope(servletContext);</span><br><span class="line">    WebApplicationContextUtils.registerEnvironmentBeans(getBeanFactory(),</span><br><span class="line">            servletContext);</span><br><span class="line">    <span class="keyword">for</span> (ServletContextInitializer beans : getServletContextInitializerBeans()) &#123;</span><br><span class="line">        beans.onStartup(servletContext); <span class="comment">//调用onStartup</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动应用 -&gt; 初始化Bean -&gt; 排序 -&gt; 迭代 -&gt; 注册到上下文 -&gt; 添加到 <code>FilterMaps</code> </p>
<p>访问url -&gt; 从上下文（context）获取（findFilterMaps）-&gt; 过滤匹配url - 添加到 <code>FilterChain</code> -&gt; <code>doFilter()</code></p>
<p>看到这里，总算有了和排序相关的一些内容，篇幅有点长，不打算在这里继续往下写了，因为需要看 <code>BeanFactory</code> 如何从 <code>scanner</code> 注册 <code>bean</code> ，篇幅也很大。目前至少能知道 <code>Filter</code> 的顺序是在初始化 <code>context</code> 的时候就已经根据 <code>order</code> 值从小到大排好序了，<code>order</code> 的值在使用 <code>FilterRegistrationBean</code> 注册的时候是 <code>registration.setOrder(1);</code> 值，如果使用或不使用 <code>@Order</code> 注解 <code>order</code> 值都是 <code>2147483647</code></p>
<p>改天闲的没事干再看如何注册 Bean 吧，看的头都晕了</p>
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">3</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2018/12/26/Java/Spring boot-about-url-path/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/geyingauv" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/geyingauv" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2018 Virle's blog</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>